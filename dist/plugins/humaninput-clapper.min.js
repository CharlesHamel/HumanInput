(function(){"use strict";navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;HumanInput.defaultListenEvents.push("clapper");var t=window.AudioContext||window.webkitAudioContext,e=60,a=function(a){var r=this;r.__name__="ClapperPlugin";r.exports={};r.startClapper=function(){var n=function(t){var n,s,o;r.stream=t;r.scriptProcessor.connect(r.context.destination);r.analyser.smoothingTimeConstant=.4;r.analyser.fftSize=128;r.streamSource=r.context.createMediaStreamSource(t);r.streamSource.connect(r.analyser);r.analyser.connect(r.scriptProcessor);r.scriptProcessor.onaudioprocess=function(){var t,i,p,l,c=Date.now();if(!n){n=c;s=c}t=c-n;i=c-s;p=c-o;if(t>e){r.analyser.getByteFrequencyData(r.freqData);if(i>=e*4&&r.freqData.filter(function(t){return t>=a.settings.clapThreshold}).length>=15){l="clap";if(i<e*8){l="doubleclap";o=c;if(p<e*12){l="applause"}}a._addDown(l);a._handleDownEvents();a._handleSeqEvents();a._removeDown(l);s=c}n=c}r.freqData=new Uint8Array(r.analyser.frequencyBinCount)}};r.context=new t;r.scriptProcessor=r.context.createScriptProcessor(1024,1,1);r.analyser=r.context.createAnalyser();r.freqData=new Uint8Array(r.analyser.frequencyBinCount);r.log.debug(a.l("Starting clap detection"));r._started=true;navigator.getUserMedia({audio:true},n,function(t){r.log.error(a.l("Could not get audio stream"),t)})};r.stopClapper=function(){r.log.debug(a.l("Stopping clap detection"));r.stream.getAudioTracks().forEach(function(t){t.stop()});r.stream.getVideoTracks().forEach(function(t){t.stop()});r.streamSource.disconnect(r.analyser);r.analyser.disconnect(r.scriptProcessor);r.scriptProcessor.disconnect(r.context.destination);r._started=false};return r};a.prototype.init=function(e){var a=this;a.log=new e.logger(e.settings.logLevel||"INFO","[HI Clapper]");a.log.debug(e.l("Initializing Clapper Plugin"),a);e.settings.autostartClapper=e.settings.autostartClapper||false;e.settings.clapThreshold=e.settings.clapThreshold||120;e.settings.autotoggleClapper=e.settings.autotoggleClapper||true;if(e.settings.listenEvents.indexOf("clapper")!=-1){if(t){if(e.settings.autostartClapper){a.startClapper()}if(e.settings.autotoggleClapper){e.on("document:hidden",function(){if(a._started){a.stopClapper()}});e.on("document:visible",function(){if(!a._started&&e.settings.autostartClapper){a.startClapper()}})}}else{a.startClapper=e.noop;a.stopClapper=e.noop}}a.exports.startClapper=a.startClapper;a.exports.stopClapper=a.stopClapper;return a};HumanInput.plugins.push(a)}).call(this);
