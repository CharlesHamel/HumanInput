(function(){"use strict";navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;HumanInput.defaultListenEvents.push("clapper");var t=window.AudioContext||window.webkitAudioContext,e=60,r=50,a=function(t){return t.reduce(function(t,e){return t+e})},n=function(t){var e=[];for(var r=1;r<t.length-1;++r){if(t[r-1]<t[r]&&t[r]>t[r+1]){e.push(r)}}return e},o=function(o){var s=this;s.__name__="ClapperPlugin";s.exports={};s.history=[];s.rollingAvg=[];s.calcHistoryAverage=function(){var t,e,r=0;for(t=0;t<s.analyser.frequencyBinCount;t++){if(s.history[t]){for(e=0;e<s.history.length;e++){r+=s.history[e][t]}s.rollingAvg[t]=r/s.history.length;r=0}}};s.startClapper=function(){var i=function(t){var i,l,c;s.stream=t;s.scriptProcessor.connect(s.context.destination);s.analyser.smoothingTimeConstant=.4;s.analyser.fftSize=128;s.streamSource=s.context.createMediaStreamSource(t);s.streamSource.connect(s.analyser);s.analyser.connect(s.scriptProcessor);s.scriptProcessor.onaudioprocess=function(){var t,p,u,f,g,d,h,y,C,v,m=Date.now();if(!i){i=m;l=m}t=m-i;p=m-l;u=m-c;if(t>e){s.freqData=new Uint8Array(s.analyser.frequencyBinCount);s.analyser.getByteFrequencyData(s.freqData);g=n(s.freqData);h=s.freqData.indexOf(Math.max.apply(null,s.freqData));d=s.freqData[h];y=s.freqData[h]-s.rollingAvg[h];if(p>=e*4){if(h<8&&y>o.settings.clapThreshold){C=a(s.freqData.slice(0,10))/a(s.freqData.slice(10,20));v=a(s.freqData.slice(0,3))/a(s.freqData.slice(3,6));if(C<1.8&&v<1.4&&g.length>2){f="clap";if(p<e*8){f="doubleclap";c=m;if(u<e*12){f="applause"}}o._addDown(f);o._handleDownEvents();o._handleSeqEvents();o._removeDown(f);l=m}}}i=m;if(l!=m){s.history.push(s.freqData);if(s.history.length>r){s.history.shift()}s.calcHistoryAverage()}}}};s.context=new t;s.scriptProcessor=s.context.createScriptProcessor(1024,1,1);s.analyser=s.context.createAnalyser();s.freqData=new Uint8Array(s.analyser.frequencyBinCount);s.log.debug(o.l("Starting clap detection"));s._started=true;navigator.getUserMedia({audio:true},i,function(t){s.log.error(o.l("Could not get audio stream"),t)})};s.stopClapper=function(){s.log.debug(o.l("Stopping clap detection"));s.stream.getAudioTracks().forEach(function(t){t.stop()});s.stream.getVideoTracks().forEach(function(t){t.stop()});s.streamSource.disconnect(s.analyser);s.analyser.disconnect(s.scriptProcessor);s.scriptProcessor.disconnect(s.context.destination);s._started=false};return s};o.prototype.init=function(e){var r=this;r.log=new e.logger(e.settings.logLevel||"INFO","[HI Clapper]");r.log.debug(e.l("Initializing Clapper Plugin"),r);e.settings.autostartClapper=e.settings.autostartClapper||false;e.settings.clapThreshold=e.settings.clapThreshold||130;e.settings.autotoggleClapper=e.settings.autotoggleClapper||true;if(e.settings.listenEvents.indexOf("clapper")!=-1){if(t){if(e.settings.autostartClapper){r.startClapper()}if(e.settings.autotoggleClapper){e.on("document:hidden",function(){if(r._started){r.stopClapper()}});e.on("document:visible",function(){if(!r._started&&e.settings.autostartClapper){r.startClapper()}})}}else{r.startClapper=e.noop;r.stopClapper=e.noop}}r.exports.startClapper=r.startClapper;r.exports.stopClapper=r.stopClapper;return r};HumanInput.plugins.push(o)}).call(this);
